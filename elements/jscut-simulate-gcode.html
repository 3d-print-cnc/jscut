<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="jscut-simulate-gcode" attributes="gcode cutterDiameter cutterHeight">
    <script src="../lib/jquery-2.1.1.min.js"></script>
    <script src="../lib/bootstrap-3.1.1/js/bootstrap.min.js"></script>
    <script src="../lib/gl-matrix-2.2.0-min.js"></script>
    <script src="../lib/webgl-utils.js"></script>
    <script src="../lib/bootstrap-slider.min.js"></script>
    <script src="../js/parseGcode.js"></script>
    <script src="../js/RenderPath.js"></script>
    <template>
        <div>
            <link href="../lib/bootstrap-3.1.1/css/bootstrap.min.css" rel="stylesheet">
            <link href="../lib/bootstrap-slider.min.css" rel="stylesheet">
            <div class="container-fluid">
                <div class="row clearfix">
                    <div class="col-md-12 column">
                        <div class="jumbotron">
                            <canvas id="renderPathCanvas" style="border: none;" width="512" height="512"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>
        (function () {
            "use strict";
            var self;
            var renderPath;
            var filled = false;

            function fill(oldValue, newValue) {
                if (filled)
                    renderPath.fillPathBuffer(parseGcode({}, self.gcode), 0, self.cutterDiameter, self.cutterHeight);
            }

            Polymer('jscut-simulate-gcode', {
                gcode: '',
                cutterDiameter: 0,
                cutterHeight: 0,

                ready: function () {
                    self = this;
                    // Chrome 36: the ready event fires after this object's shadow-root is created,
                    // but before parent shadow-roots are created. That causes WebGL initialization to
                    // fail. requestAnimationFrame works around this. Firefox doesn't have this problem.
                    window.requestAnimationFrame(function () {
                        renderPath = startRenderPath({}, self.$.renderPathCanvas, null, function (renderPath) {
                            renderPath.fillPathBuffer(parseGcode({}, self.gcode), 0, self.cutterDiameter, self.cutterHeight);
                            filled = true;
                        });
                    });
                },

                gcodeChanged: fill,
                cutterDiameterChanged: fill,
                cutterHeightChanged: fill,
            });
        })();
    </script>
</polymer-element>
